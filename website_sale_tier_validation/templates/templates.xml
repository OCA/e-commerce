<?xml version="1.0" encoding="utf-8" ?>
<odoo>
<!--  Sales from e-commerce  -->
    <template id="validation_page" name="Order Need Validation">
        <t t-call="website.layout">
            <t t-set="additional_title">Shop - Request validation</t>
            <t t-set="no_footer">1</t>

            <div id="wrap">
                <div class="container oe_website_sale py-2">
                    <div class="row">
                        <div class='col-12'>
                            <t t-call="website_sale.wizard_checkout">
                                <t t-set="step" t-value="40" />
                            </t>
                        </div>
                        <div class="col-12" t-if="errors">
                            <t t-foreach="errors" t-as="error">
                                <div
                                    class="alert alert-danger"
                                    t-if="error"
                                    role="alert"
                                >
                                    <h4>
                                        <t t-esc="error[0]" />
                                    </h4>
                                    <t t-esc="error[1]" />
                                </div>
                            </t>
                        </div>
                        <div class="col-12 col-xl-auto order-xl-2">
                            <t t-call="website_sale.cart_summary" />
                        </div>
                        <div class="col-12 col-xl order-xl-1 oe_cart">
                            <div class="card">
                                <div class="card-body" id="shipping_and_billing">
                                    <a
                                        class='float-right no-decoration'
                                        href='/shop/checkout'
                                    ><i class="fa fa-edit" /> Edit</a>
                                    <t
                                        t-set="same_shipping"
                                        t-value="bool(order.partner_shipping_id==order.partner_id or only_services)"
                                    />
                                    <div><b>Billing<t
                                                t-if="same_shipping and not only_services"
                                            > &amp; Shipping</t>: </b><span
                                            t-esc='order.partner_id'
                                            t-options="dict(widget='contact', fields=['address'], no_marker=True, separator=', ')"
                                            class="address-inline"
                                        /></div>
                                    <div
                                        t-if="not same_shipping and not only_services"
                                        groups="sale.group_delivery_invoice_address"
                                    ><b>Shipping: </b><span
                                            t-esc='order.partner_shipping_id'
                                            t-options="dict(widget='contact', fields=['address'], no_marker=True, separator=', ')"
                                            class="address-inline"
                                        /></div>
                                </div>
                            </div>

                            <div
                                class="oe_structure clearfix mt-3"
                                id="oe_structure_website_sale_payment_1"
                            />

                            <div id="request_review_info">
                                <h3 class="mb24">Request Validation </h3>
                                <div class="alert alert-dismissible alert-warning">
                                    <span>
                                        <i class="fa fa-info-circle" />
                                        The order needs to be reviewed, please request
                                        to reviewers the revision and you will be
                                        noticed to email with the response.
                                    </span>
                                </div>
                            </div>
                            <div class="js_payment mt-3" id="request_order_review">
                                <form
                                    target="_self"
                                    action="/shop/payment/validate"
                                    method="post"
                                    class="float-right"
                                >
                                    <input
                                        type="hidden"
                                        name="csrf_token"
                                        t-att-value="request.csrf_token()"
                                    />
                                    <a
                                        role="button"
                                        class="btn btn-primary a-submit"
                                        href="#"
                                    >
                                        <span>Request Validation <span
                                                class="fa fa-hourglass-half"
                                            /></span>
                                    </a>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="oe_structure" id="oe_structure_website_sale_payment_2" />
            </div>
        </t>
    </template>

    <template id="wizard_checkout" inherit_id="website_sale.wizard_checkout">
        <xpath expr="//div[@id='wizard-step40']" position="attributes">
            <attribute
                name="t-if"
            >not website_sale_order.need_validation and not website_sale_order.review_ids</attribute>
        </xpath>
        <xpath expr="//div[@id='wizard-step40']" position="after">
            <div
                t-if="website_sale_order.need_validation or website_sale_order.review_ids"
                id="wizard-step40"
                t-att-class="'progress-wizard-step %s' % (step == 40 and 'active' or step&gt;40 and 'complete' or 'disabled')"
            >
                <div class="progress-wizard-bar d-none d-md-block" />
                <span class="progress-wizard-dot d-none d-md-inline-block" />
                <div
                    class="text-center progress-wizard-steplabel"
                >Request Validation</div>
              </div>
        </xpath>
    </template>

<!--  Paying from Portal  -->
    <template
        id="sale_order_portal_template"
        inherit_id="sale.sale_order_portal_template"
    >
        <xpath expr="//div[@id='modalaccept']" position="after">
            <div role="dialog" class="modal fade" id="modalvalidate">
                <div class="modal-dialog">
                    <form
                        id="validate"
                        method="POST"
                        t-attf-action="/my/orders/#{sale_order.id}/validate?access_token=#{sale_order.access_token}"
                        class="js_validate_json modal-content js_website_submit_form"
                    >
                        <input
                            type="hidden"
                            name="csrf_token"
                            t-att-value="request.csrf_token()"
                        />
                        <header class="modal-header">
                            <h4 class="modal-title">Request Validation</h4>
                            <button
                                type="button"
                                class="close"
                                data-dismiss="modal"
                                aria-label="Close"
                            >&amp;times;</button>
                        </header>
                        <main class="modal-body">
                            <p>
                                Request validation to sales manager and wait for the response.
                            </p>
                            <br />
                            <p>
                                You will receive an email confirming that you request the validation.
                            </p>
                        </main>
                        <footer class="modal-footer">
                            <button
                                type="submit"
                                t-att-id="sale_order.id"
                                class="btn btn-primary"
                            ><i
                                    class="fa fa-hourglass-half"
                                /> Request Validation</button>
                            <button
                                type="button"
                                class="btn btn-danger"
                                data-dismiss="modal"
                            >Cancel</button>
                        </footer>
                    </form>
                </div>
            </div>

            <div
                t-if="message == 'cant_validate'"
                class="alert alert-danger alert-dismissable d-print-none"
                role="alert"
            >
                <button
                    type="button"
                    class="close"
                    data-dismiss="alert"
                    aria-label="Close"
                >&amp;times;</button>
                Your order has been requested for validation yet.
            </div>
            <div
                t-if="sale_order.review_ids and not sale_order.validated and not sale_order.rejected"
                class="alert alert-warning alert-dismissable d-print-none"
                role="alert"
            >
                <span t-field="sale_order.to_validate_message" />
            </div>
            <div
                t-if="sale_order.review_ids and sale_order.validated"
                class="alert alert-success alert-dismissable d-print-none"
                role="alert"
            >
                <span t-field="sale_order.validated_message" />
            </div>
            <div
                t-if="sale_order.review_ids and sale_order.rejected"
                class="alert alert-danger alert-dismissable d-print-none"
                role="alert"
            >
                <span t-field="sale_order.rejected_message" />
            </div>
        </xpath>
        <xpath expr="//a[@t-if='sale_order.has_to_be_signed(True)']" position="before">
            <a
                t-if="sale_order.need_validation"
                role="button"
                class="btn btn-primary btn-block mb8"
                data-toggle="modal"
                data-target="#modalvalidate"
                href="#"
            >
                <i class="fa fa-hourglass-half" /> Request Validation
            </a>
        </xpath>
        <xpath
            expr="//a[@t-if='sale_order.has_to_be_signed(True)']"
            position="attributes"
        >
            <attribute
                name="t-if"
            >sale_order.has_to_be_signed(True) and not sale_order.need_validation and (not sale_order.review_ids or sale_order.validated)</attribute>
        </xpath>
        <xpath
            expr="//a[@t-elif='sale_order.has_to_be_paid(True)']"
            position="attributes"
        >
            <attribute
                name="t-elif"
            >sale_order.has_to_be_paid(True) and not sale_order.need_validation and (not sale_order.review_ids or sale_order.validated)</attribute>
        </xpath>
        <xpath
            expr="//div[@t-if='sale_order.has_to_be_signed(True) or sale_order.has_to_be_paid(True)']"
            position="before"
        >
            <div
                t-if="sale_order.need_validation"
                class="row justify-content-center text-center d-print-none pt-1 pb-4"
            >
                <div class="col-sm-auto mt8">
                    <a
                        role="button"
                        class="btn btn-primary"
                        data-toggle="modal"
                        data-target="#modalvalidate"
                        href="#"
                    ><i class="fa fa-hourglass-half" /> Request Validation</a>
                </div>
            </div>
        </xpath>
        <xpath
            expr="//div[@t-if='sale_order.has_to_be_signed(True) or sale_order.has_to_be_paid(True)']"
            position="attributes"
        >
            <attribute
                name="t-if"
            >(sale_order.has_to_be_signed(True) or sale_order.has_to_be_paid(True)) and not sale_order.need_validation and (not sale_order.review_ids or sale_order.validated)</attribute>
        </xpath>
    </template>
</odoo>
